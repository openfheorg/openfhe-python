##############################################################################################
### NOTE: try not to change this file at all. Everything can be controlled by input parameters
###       passed to this reuseable workflow from the wrapper workflow.
###       The only hardcoded value here is the location to the builder.
##############################################################################################
name: Reuseable Generic Workflow

on:
  workflow_call:
    inputs:
      runner:
        description: 'Runner tag'
        type: string
        required: true
      compiler:
        description: 'Compiler type'
        type: string
        required: true
      native_backend:
        description: 'Size of NativeInteger'
        type: string
      openfhe_development_branch:
        description: 'openfhe-development branch'
        type: string
        required: true
          
jobs:
  init:
    runs-on: ${{ inputs.runner }}
    outputs:
      integer_size: ${{ steps.int_size.outputs.integer_size }}
      compiler: ${{ steps.compiler.outputs.compiler_args }}
    steps:
      - name: Print input parmeters
        id: print_values
        run: |
          echo "===================== INPUT ======================="
          echo "runner                     : ${{ inputs.runner }}"
          echo "compiler                   : ${{ inputs.compiler }}"
          echo "native_backend             : ${{ inputs.native_backend }}"
          echo "openfhe_development_branch : ${{ inputs.openfhe_development_branch }}"
          echo "==================================================="

      - name: Get NativeInteger size for matrix
        id: int_size
        run: |
          input_value="${{ inputs.native_backend }}"
          if [ "$input_value" == "32" ]; then
            echo "integer_size=['32']"
            echo "integer_size=['32']" >> $GITHUB_OUTPUT
          elif [ "$input_value" == "64" ]; then
            echo "integer_size=['64']"
            echo "integer_size=['64']" >> $GITHUB_OUTPUT
          elif [ "$input_value" == "128" ]; then
            echo "integer_size=['128']"
            echo "integer_size=['128']" >> $GITHUB_OUTPUT
          else
            echo "integer_size=['32', '64', '128']"
            echo "integer_size=['32', '64', '128']" >> $GITHUB_OUTPUT
          fi

      - name: Get compiler as args for cmake
        id: compiler
        run: echo "compiler_args=${{ fromJson(env.COMPILERS_MAP)[inputs.compiler] }}" >> $GITHUB_OUTPUT
        env:
          # JSON map to convert input Compiler Type to a string with cmake arguments to set the compiler for C and C++
          COMPILERS_MAP: >-
            {
              "GCC-14"    : "-DCMAKE_CXX_COMPILER=/usr/bin/g++-14 -DCMAKE_C_COMPILER=/usr/bin/gcc-14",
              "CLANG-18"  : "-DCMAKE_CXX_COMPILER=/usr/bin/clang++-18 -DCMAKE_C_COMPILER=/usr/bin/clang-18",
            }

  ###############################################
  #
  #    default jobs starts here
  #
  ###############################################
  default:
    strategy:
      matrix:
        integer_size: ${{ fromJson(needs.init.outputs.integer_size) }}

    needs: init
    runs-on: ${{ inputs.runner }}
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Print parameters passed to .github/actions
      run: |
        echo "runs-on:     ${{ inputs.runner }}"
        echo "module_name: ${{ github.job }}"
        echo "openfhe_development_branch: ${{ inputs.openfhe_development_branch }}"
        echo "cmake_args_openfhe_lib:  ${{ needs.init.outputs.compiler }} -DNATIVE_SIZE=${{ matrix.integer_size }}"

    - name: ${{ github.job }}
      uses: openfheorg/openfhe-python/.github/actions/generic_workflow_builder@github-ci
      with:
        module_name: ${{ github.job }}
        openfhe_development_branch: ${{ inputs.openfhe_development_branch }}
        cmake_args_openfhe_lib: "${{ needs.init.outputs.compiler }} -DNATIVE_SIZE=${{ matrix.integer_size }}"

